<Window x:Class="FruVa.Ordering.Ui.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="Orders"
        Height="600"
        Width="900"
        MinHeight="400"
        MinWidth="700"
        x:Name="this">

    <Window.Resources>
        <Thickness x:Key="OuterMargin">16</Thickness>
        <Thickness x:Key="InnerMargin">8</Thickness>
        <Thickness x:Key="CellPadding">4</Thickness>

        <sys:String x:Key="GlyphAdd">+</sys:String>
        <sys:String x:Key="GlyphSearch">🔍</sys:String>
        <sys:String x:Key="GlyphDelete">✖</sys:String>
        <sys:String x:Key="GlyphCsv">🗎</sys:String>

        <Style TargetType="DataGrid" x:Key="OrdersDataGridBaseStyle">
            <Setter Property="AutoGenerateColumns" Value="False" />
            <Setter Property="SelectionMode" Value="Single" />
            <Setter Property="SelectionUnit" Value="FullRow" />
            <Setter Property="IsReadOnly" Value="True" />
            <Setter Property="CanUserAddRows" Value="False" />
            <Setter Property="CanUserDeleteRows" Value="False" />
            <Setter Property="Margin" Value="{StaticResource InnerMargin}" />
            <Setter Property="RowHeaderWidth" Value="0" />
        </Style>

        <Style TargetType="DataGrid" x:Key="LinesDataGridBaseStyle" BasedOn="{StaticResource OrdersDataGridBaseStyle}">
            <Setter Property="IsReadOnly" Value="False" />
        </Style>

        <Style TargetType="Button" x:Key="GridDeleteButtonStyle">
            <Setter Property="Padding" Value="2" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="MinWidth" Value="20" />
            <Setter Property="HorizontalAlignment" Value="Center" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Content" Value="{StaticResource GlyphDelete}" />
        </Style>

        <DataTemplate x:Key="GroupHeaderWithAddTemplate">
            <DockPanel LastChildFill="True">

                <Button DockPanel.Dock="Right"
                    Padding="2"
                    Margin="5,0,0,0"
                    Content="{StaticResource GlyphAdd}"
                    ToolTip="Add"
                    Command="{Binding DataContext.AddOrderCommand, RelativeSource={RelativeSource AncestorType=Window}}" />
                
                <Button DockPanel.Dock="Right"
                    Padding="2"
                    Margin="5,0,0,0"
                    Content="{StaticResource GlyphCsv}"
                    ToolTip="Export to CSV"
                    Command="{Binding DataContext.ExportToCsvCommand, RelativeSource={RelativeSource AncestorType=Window}}" />

                <TextBlock Text="Orders"
                   FontWeight="Bold"
                   VerticalAlignment="Center"
                   Margin="0,0,8,0" />
            </DockPanel>
        </DataTemplate>


        <DataTemplate x:Key="RecipientSelectorTemplate">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox Grid.Column="0"
                         Margin="0"
                         Padding="{StaticResource CellPadding}"
                         Text="{Binding Recipient.DisplayName, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True, NotifyOnValidationError=True}" />
                <Button Grid.Column="1"
                        Margin="4,0,0,0"
                        Padding="4,0"
                        Content="{StaticResource GlyphSearch}"
                        ToolTip="Find Recipient"
                        Command="{Binding DataContext.FindRecipientsCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding}" />

            </Grid>
        </DataTemplate>


        <DataTemplate x:Key="ArticleSelectorTemplate">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button Grid.Column="1"
                        Margin="4,0,0,0"
                        Padding="4,0"
                        Content="{StaticResource GlyphSearch}"
                        ToolTip="Find Article"
                        Command="{Binding DataContext.FindArticlesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding}" />
            </Grid>
        </DataTemplate>


        <Style TargetType="DataGrid" x:Key="OrderLinesGridStyle" BasedOn="{StaticResource LinesDataGridBaseStyle}">
            <Setter Property="HeadersVisibility" Value="Column" />
        </Style>

    </Window.Resources>


    <Grid Margin="{StaticResource OuterMargin}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="4*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>


        <GroupBox Grid.Row="0"
                  Grid.Column="0"
                  Margin="0,0,16,0"
                  HeaderTemplate="{StaticResource GroupHeaderWithAddTemplate}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="3*"/>
                    <ColumnDefinition Width="14*"/>
                </Grid.ColumnDefinitions>
                <DataGrid x:Name="OrdersDataGrid"
                          Style="{StaticResource OrdersDataGridBaseStyle}"
                          ItemsSource="{Binding Orders}"
                          SelectedItem="{Binding SelectedOrder, Mode=TwoWay}" Grid.ColumnSpan="2" Margin="8,8,8,8">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Nr."
                                            Width="SizeToCells"
                                            Binding="{Binding OrderNumber}" />
                        <DataGridTextColumn Header="Title"
                                            Width="*"
                                            Binding="{Binding Recipient.DisplayName}" />
                        <DataGridTextColumn Header="Preis"
                                            Width="Auto"
                                            Binding="{Binding TotalPrice, StringFormat={}{0:C}}" />
                        <DataGridTemplateColumn Header=""
                                                Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource GridDeleteButtonStyle}"
                                          Command="{Binding DataContext.DeleteOrderCommand, 
                                        RelativeSource={RelativeSource AncestorType=Window}}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </GroupBox>

        <!-- Separator  -->
        <GridSplitter Grid.Row="0"
                      Grid.Column="1"
                      Width="8"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Stretch"
                      Background="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                      ShowsPreview="True" />

        <!-- Details Group  -->
        <GroupBox Grid.Row="0"
                  Grid.Column="2"
                  Header="Details"
                  IsEnabled="{Binding IsDetailAreaEnabled}">
            <Grid Margin="{StaticResource InnerMargin}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <!-- Order Nr -->
                    <RowDefinition Height="Auto" />
                    <!-- Recipient -->
                    <RowDefinition Height="Auto" />
                    <!-- Customer Name display -->
                    <RowDefinition Height="Auto" />
                    <!-- Article Search -->
                    <RowDefinition Height="*" />
                    <!-- Lines -->
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="DetailsLabels" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Order Number -->
                <TextBlock Grid.Row="0"
                           Grid.Column="0"
                           Text="Nr.:"
                           VerticalAlignment="Center" />
                <TextBox Grid.Row="0"
                         Grid.Column="1"
                         Margin="0"
                         Padding="{StaticResource CellPadding}"
                         IsReadOnly="True"
                         Text="{Binding SelectedOrder.OrderNumber}" />

                <!-- Recipient Search -->
                <TextBlock Grid.Row="1"
                           Grid.Column="0"
                           Text="Recipient:"
                           IsEnabled="False"
                           VerticalAlignment="Center" />

                <ContentPresenter Grid.Row="1"
                                  Grid.Column="1"
                                  Content="{Binding SelectedOrder}"
                                  ContentTemplate="{StaticResource RecipientSelectorTemplate}" />

                <!-- Article Search (to add lines) -->
                <TextBlock Grid.Row="3"
                           Grid.Column="0"
                           Text="Article:"
                           VerticalAlignment="Center" />

                <ContentPresenter Grid.Row="3"
                                  Grid.Column="1"
                                  Content="{Binding SelectedOrder}"
                                  ContentTemplate="{StaticResource ArticleSelectorTemplate}" />

                <!-- Lines Grid -->
                <DataGrid Grid.Row="4"
                          Grid.Column="0"
                          Grid.ColumnSpan="2"
                          Style="{StaticResource OrderLinesGridStyle}"
                          ItemsSource="{Binding SelectedOrder.OrderDetails}"
                          SelectedItem="{Binding SelectedOrderDetail}">

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Qty"
                                            Width="Auto"
                                            Binding="{Binding Quantity, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True, NotifyOnValidationError=True}" />
                        <DataGridTextColumn Header="Article"
                                            Width="*"
                                            Binding="{Binding Article.DisplayName, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True, NotifyOnValidationError=True}" />
                        <DataGridTextColumn Header="Preis"
                                            Width="Auto"
                                            Binding="{Binding Price, StringFormat={}{0:C}}" />
                        <DataGridTemplateColumn Header=""
                                                Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource GridDeleteButtonStyle}"
                                            Command="{Binding DataContext.DeleteOrderDetailCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </GroupBox>

        <StackPanel Grid.Row="1"
                    Grid.Column="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,16,0,0">

            <Button Content="Save" Width="100" Height="30" Margin="5 0" Command="{Binding SaveCommand}"/>


            <Button Content="Cancel"
               Width="100"
               Height="30"
               Command="{Binding CancelCommand}"
               CommandParameter="{Binding ElementName=this}"/>

        </StackPanel>
    </Grid>
</Window>
    